rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isOrgMember(orgId) {
       // This is a simplified check. In production you'd check a custom claim or a user_org lookup
       // For this MVP refactor, we are using the fact that the user document contains the orgId
       // But rules CANNOT read the user doc easily without extra reads.
       // A common pattern is to put orgId on Custom Claims in auth token.
       // For now, let's just ensure they are authenticated for the beta.
       // We will restrict writes more strictly.
       return isAuthenticated(); 
    }

    // User Profiles
    match /users/{userId} {
      allow read: if isAuthenticated(); // Should be restricted to same org or self
      allow write: if isOwner(userId); // Users can update their own profile
      allow create: if isAuthenticated(); // Allow creation on signup
    }

    // Organizations (High Level)
    // Organizations (High Level)
    match /organizations/{orgId} {
      allow get: if true; // Public access for branding
      allow list: if isAuthenticated();
      allow create: if isAuthenticated(); // Allow creation on signup
      allow update: if isAuthenticated() && resource.data.ownerId == request.auth.uid; // Only owner can update the org root doc (settings)
      
      // Subcollections within Organization
      match /jobs/{jobId} {
        allow read: if true; // Public access for job listings
        allow write: if isAuthenticated(); 
      }
      
      match /candidates/{candidateId} {
        allow read, write: if isAuthenticated();
      }
      
      match /invitations/{inviteId} {
        allow read, write: if isAuthenticated();
      }
    }
    
    // Legacy collections (blocking access or redirecting logic if needed)
    match /jobs/{jobId} {
       allow read, write: if false; 
    }
    match /candidates/{candidateId} {
       allow read, write: if false;
    }
    match /config/{configId} {
       allow read, write: if false;
    }
  }
}
