rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isOrgMember(orgId) {
       // Validate org membership via custom claim set by setOrgClaim Cloud Function
       return isAuthenticated() && request.auth.token.orgId == orgId;
    }

    // User Profiles
    match /users/{userId} {
      allow read: if isOwner(userId) || (isAuthenticated() && request.auth.token.orgId != null);
      allow write: if isOwner(userId);
      allow create: if isAuthenticated();
    }

    // Organizations (High Level)
    match /organizations/{orgId} {
      allow get: if true; // Public access for branding (career pages)
      allow list: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isOrgMember(orgId) && resource.data.ownerId == request.auth.uid;

      // Subcollections within Organization â€” org members only
      match /jobs/{jobId} {
        allow read: if true; // Public access for job listings
        allow write: if isOrgMember(orgId);
      }

      match /candidates/{candidateId} {
        allow read: if isOrgMember(orgId);
        // Allow writes from org members OR anonymous/token-mode users (for job applications)
        allow create: if isAuthenticated();
        allow update, delete: if isOrgMember(orgId);
      }

      match /invitations/{inviteId} {
        allow read, write: if isOrgMember(orgId);
        // Allow reading invite by anyone authenticated (for accepting invites)
        allow get: if isAuthenticated();
      }

      match /assessments/{assessmentId} {
        allow read, write: if isOrgMember(orgId);
      }
    }

    // Legacy collections (blocked)
    match /jobs/{jobId} {
       allow read, write: if false;
    }
    match /candidates/{candidateId} {
       allow read, write: if false;
    }
    match /config/{configId} {
       allow read, write: if false;
    }
  }
}
